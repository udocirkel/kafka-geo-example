networks:
  dc1:
    driver: bridge
    ipam:
      config:
        - subnet: 192.168.155.0/24
  dc2:
    driver: bridge
    ipam:
      config:
        - subnet: 192.168.156.0/24

services:

  # Kafka Console (AKHQ) => http://localhost:8081
  # Demo Service         => http://localhost:8087

  #############################################
  ###  Kafka Cluster - Data Center 1 (DC1)  ###
  #############################################

  zookeeper-dc1:
    image: confluentinc/cp-zookeeper:7.8.6
    hostname: zookeeper-dc1
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
      ZOOKEEPER_SYNC_LIMIT: 2
    healthcheck:
      test: [ "CMD-SHELL", "echo 'create -e /healthcheck test' | /usr/bin/zookeeper-shell localhost:2181 >/tmp/zk 2>&1 && grep -q Created /tmp/zk && echo 'delete /healthcheck' | /usr/bin/zookeeper-shell localhost:2181 >/dev/null 2>&1" ]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 30s
    volumes:
      - ./data/dc_failover_demo/zookeeper_dc1/data:/var/lib/zookeeper/data
      - ./data/dc_failover_demo/zookeeper_dc1/log:/var/lib/zookeeper/log
    networks:
      dc1:
        ipv4_address: 192.168.155.2

  kafka1-dc1:
    image: confluentinc/cp-kafka:7.8.6
    hostname: kafka1-dc1
    depends_on:
      zookeeper-dc1:
        condition: service_healthy
    restart: on-failure:5
    environment:
      # Broker identity
      KAFKA_BROKER_ID: 1                                         # Unique ID for this broker in the cluster
      # Broker connectivity
      KAFKA_ZOOKEEPER_CONNECT: zookeeper-dc1:2181                # Zookeeper connection string for cluster coordination
      KAFKA_LISTENERS: PLAINTEXT://:9092                         # Network interfaces (all: 0.0.0.0) and ports (9092) the broker listens on
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka1-dc1:9092    # Hostname and port advertised to clients
      # Topic auto-creation
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: false                     # Disables automatic topic creation on first access to avoid misconfigured topics using broker defaults
      # Defaults for newly created topics
      KAFKA_DEFAULT_REPLICATION_FACTOR: 3                        # Ensures new topics are replicated across multiple brokers for fault tolerance
      KAFKA_MIN_INSYNC_REPLICAS: 2                               # Ensures writes are only acknowledged when at least a quorum of replicas is in sync
      KAFKA_UNCLEAN_LEADER_ELECTION_ENABLE: false                # Prevents a not fully in sync broker from being elected leader, avoiding potential data loss
      # Leader rebalancing
      KAFKA_AUTO_LEADER_REBALANCE_ENABLE: true                   # Automatically rebalance partition leadership among brokers to avoid overload
      KAFKA_LEADER_IMBALANCE_CHECK_INTERVAL_SECONDS: 60          # Interval to check for leader imbalance across brokers
      KAFKA_LEADER_IMBALANCE_PER_BROKER_PERCENTAGE: 10           # Threshold (%) of partitions per broker beyond which a rebalance is triggered
      # Internal __consumer_offsets topic
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_OFFSETS_TOPIC_MIN_ISR: 2
      # Internal __transaction_state topic
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 2
      # Logging configuration
      KAFKA_LOG4J_LOGGERS: "kafka.controller=DEBUG,state.change.logger=DEBUG"
    healthcheck:
      test: [ "CMD", "bash", "-c", "kafka-broker-api-versions --bootstrap-server kafka1-dc1:9092 > /dev/null 2>&1" ]
      interval: 10s
      timeout: 10s
      retries: 12
      start_period: 30s
    volumes:
      - ./data/dc_failover_demo/kafka1_dc1:/var/lib/kafka/data
    networks:
      dc1:
        ipv4_address: 192.168.155.10

  kafka2-dc1:
    image: confluentinc/cp-kafka:7.8.6
    hostname: kafka2-dc1
    depends_on:
      zookeeper-dc1:
        condition: service_healthy
    restart: on-failure:5
    environment:
      # Broker identity
      KAFKA_BROKER_ID: 2
      # Broker connectivity
      KAFKA_ZOOKEEPER_CONNECT: zookeeper-dc1:2181
      KAFKA_LISTENERS: PLAINTEXT://:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka2-dc1:9092
      # Topic auto-creation
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: false
      # Defaults for newly created topics
      KAFKA_DEFAULT_REPLICATION_FACTOR: 3
      KAFKA_MIN_INSYNC_REPLICAS: 2
      KAFKA_UNCLEAN_LEADER_ELECTION_ENABLE: false
      # Leader rebalancing
      KAFKA_AUTO_LEADER_REBALANCE_ENABLE: true
      KAFKA_LEADER_IMBALANCE_CHECK_INTERVAL_SECONDS: 60
      KAFKA_LEADER_IMBALANCE_PER_BROKER_PERCENTAGE: 10
      # Internal __consumer_offsets topic
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_OFFSETS_TOPIC_MIN_ISR: 2
      # Internal __transaction_state topic
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 2
      # Logging configuration
      KAFKA_LOG4J_LOGGERS: "kafka.controller=DEBUG,state.change.logger=DEBUG"
    healthcheck:
      test: [ "CMD", "bash", "-c", "kafka-broker-api-versions --bootstrap-server kafka2-dc1:9092 > /dev/null 2>&1" ]
      interval: 10s
      timeout: 10s
      retries: 12
      start_period: 30s
    volumes:
      - ./data/dc_failover_demo/kafka2_dc1:/var/lib/kafka/data
    networks:
      dc1:
        ipv4_address: 192.168.155.11

  kafka3-dc1:
    image: confluentinc/cp-kafka:7.8.6
    hostname: kafka3-dc1
    depends_on:
      zookeeper-dc1:
        condition: service_healthy
    restart: on-failure:5
    environment:
      # Broker identity
      KAFKA_BROKER_ID: 3
      # Broker connectivity
      KAFKA_ZOOKEEPER_CONNECT: zookeeper-dc1:2181
      KAFKA_LISTENERS: PLAINTEXT://:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka3-dc1:9092
      # Topic auto-creation
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: false
      # Defaults for newly created topics
      KAFKA_DEFAULT_REPLICATION_FACTOR: 3
      KAFKA_MIN_INSYNC_REPLICAS: 2
      KAFKA_UNCLEAN_LEADER_ELECTION_ENABLE: false
      # Leader rebalancing
      KAFKA_AUTO_LEADER_REBALANCE_ENABLE: true
      KAFKA_LEADER_IMBALANCE_CHECK_INTERVAL_SECONDS: 60
      KAFKA_LEADER_IMBALANCE_PER_BROKER_PERCENTAGE: 10
      # Internal __consumer_offsets topic
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_OFFSETS_TOPIC_MIN_ISR: 2
      # Internal __transaction_state topic
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 2
      # Logging configuration
      KAFKA_LOG4J_LOGGERS: "kafka.controller=DEBUG,state.change.logger=DEBUG"
    healthcheck:
      test: [ "CMD", "bash", "-c", "kafka-broker-api-versions --bootstrap-server kafka3-dc1:9092 > /dev/null 2>&1" ]
      interval: 10s
      timeout: 10s
      retries: 12
      start_period: 30s
    volumes:
      - ./data/dc_failover_demo/kafka3_dc1:/var/lib/kafka/data
    networks:
      dc1:
        ipv4_address: 192.168.155.12

  #############################################
  ###  Kafka Cluster - Data Center 2 (DC2)  ###
  #############################################

  zookeeper-dc2:
    image: confluentinc/cp-zookeeper:7.8.6
    hostname: zookeeper-dc2
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
      ZOOKEEPER_SYNC_LIMIT: 2
    healthcheck:
      test: [ "CMD-SHELL", "echo 'create -e /healthcheck test' | /usr/bin/zookeeper-shell localhost:2181 >/tmp/zk 2>&1 && grep -q Created /tmp/zk && echo 'delete /healthcheck' | /usr/bin/zookeeper-shell localhost:2181 >/dev/null 2>&1" ]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 30s
    volumes:
      - ./data/dc_failover_demo/zookeeper_dc2/data:/var/lib/zookeeper/data
      - ./data/dc_failover_demo/zookeeper_dc2/log:/var/lib/zookeeper/log
    networks:
      dc2:
        ipv4_address: 192.168.156.2

  kafka1-dc2:
    image: confluentinc/cp-kafka:7.8.6
    hostname: kafka1-dc2
    depends_on:
      zookeeper-dc2:
        condition: service_healthy
    restart: on-failure:5
    environment:
      # Broker identity
      KAFKA_BROKER_ID: 4
      # Broker connectivity
      KAFKA_ZOOKEEPER_CONNECT: zookeeper-dc2:2181
      KAFKA_LISTENERS: PLAINTEXT://:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka1-dc2:9092
      # Topic auto-creation
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: false
      # Defaults for newly created topics
      KAFKA_DEFAULT_REPLICATION_FACTOR: 3
      KAFKA_MIN_INSYNC_REPLICAS: 2
      KAFKA_UNCLEAN_LEADER_ELECTION_ENABLE: false
      # Leader rebalancing
      KAFKA_AUTO_LEADER_REBALANCE_ENABLE: true
      KAFKA_LEADER_IMBALANCE_CHECK_INTERVAL_SECONDS: 60
      KAFKA_LEADER_IMBALANCE_PER_BROKER_PERCENTAGE: 10
      # Internal __consumer_offsets topic
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_OFFSETS_TOPIC_MIN_ISR: 2
      # Internal __transaction_state topic
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 2
      # Logging configuration
      KAFKA_LOG4J_LOGGERS: "kafka.controller=DEBUG,state.change.logger=DEBUG"
    healthcheck:
      test: [ "CMD", "bash", "-c", "kafka-broker-api-versions --bootstrap-server kafka1-dc2:9092 > /dev/null 2>&1" ]
      interval: 10s
      timeout: 10s
      retries: 12
      start_period: 30s
    volumes:
      - ./data/dc_failover_demo/kafka1_dc2:/var/lib/kafka/data
    networks:
      dc2:
        ipv4_address: 192.168.156.10

  kafka2-dc2:
    image: confluentinc/cp-kafka:7.8.6
    hostname: kafka2-dc2
    depends_on:
      zookeeper-dc2:
        condition: service_healthy
    restart: on-failure:5
    environment:
      # Broker identity
      KAFKA_BROKER_ID: 5
      # Broker connectivity
      KAFKA_ZOOKEEPER_CONNECT: zookeeper-dc2:2181
      KAFKA_LISTENERS: PLAINTEXT://:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka2-dc2:9092
      # Topic auto-creation
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: false
      # Defaults for newly created topics
      KAFKA_DEFAULT_REPLICATION_FACTOR: 3
      KAFKA_MIN_INSYNC_REPLICAS: 2
      KAFKA_UNCLEAN_LEADER_ELECTION_ENABLE: false
      # Leader rebalancing
      KAFKA_AUTO_LEADER_REBALANCE_ENABLE: true
      KAFKA_LEADER_IMBALANCE_CHECK_INTERVAL_SECONDS: 60
      KAFKA_LEADER_IMBALANCE_PER_BROKER_PERCENTAGE: 10
      # Internal __consumer_offsets topic
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_OFFSETS_TOPIC_MIN_ISR: 2
      # Internal __transaction_state topic
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 2
      # Logging configuration
      KAFKA_LOG4J_LOGGERS: "kafka.controller=DEBUG,state.change.logger=DEBUG"
    healthcheck:
      test: [ "CMD", "bash", "-c", "kafka-broker-api-versions --bootstrap-server kafka2-dc2:9092 > /dev/null 2>&1" ]
      interval: 10s
      timeout: 10s
      retries: 12
      start_period: 30s
    volumes:
      - ./data/dc_failover_demo/kafka2_dc2:/var/lib/kafka/data
    networks:
      dc2:
        ipv4_address: 192.168.156.11

  kafka3-dc2:
    image: confluentinc/cp-kafka:7.8.6
    hostname: kafka3-dc2
    depends_on:
      zookeeper-dc2:
        condition: service_healthy
    restart: on-failure:5
    environment:
      # Broker identity
      KAFKA_BROKER_ID: 6
      # Broker connectivity
      KAFKA_ZOOKEEPER_CONNECT: zookeeper-dc2:2181
      KAFKA_LISTENERS: PLAINTEXT://:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka3-dc2:9092
      # Topic auto-creation
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: false
      # Defaults for newly created topics
      KAFKA_DEFAULT_REPLICATION_FACTOR: 3
      KAFKA_MIN_INSYNC_REPLICAS: 2
      KAFKA_UNCLEAN_LEADER_ELECTION_ENABLE: false
      # Leader rebalancing
      KAFKA_AUTO_LEADER_REBALANCE_ENABLE: true
      KAFKA_LEADER_IMBALANCE_CHECK_INTERVAL_SECONDS: 60
      KAFKA_LEADER_IMBALANCE_PER_BROKER_PERCENTAGE: 10
      # Internal __consumer_offsets topic
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_OFFSETS_TOPIC_MIN_ISR: 2
      # Internal __transaction_state topic
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 2
      # Logging configuration
      KAFKA_LOG4J_LOGGERS: "kafka.controller=DEBUG,state.change.logger=DEBUG"
    healthcheck:
      test: [ "CMD", "bash", "-c", "kafka-broker-api-versions --bootstrap-server kafka3-dc2:9092 > /dev/null 2>&1" ]
      interval: 10s
      timeout: 10s
      retries: 12
      start_period: 30s
    volumes:
      - ./data/dc_failover_demo/kafka3_dc2:/var/lib/kafka/data
    networks:
      dc2:
        ipv4_address: 192.168.156.12

  ################################################
  ###  MirrorMaker 2 (single worker for demo)  ###
  ################################################

  mirrormaker-dc2:
    image: apache/kafka:4.1.1
    depends_on:
      - kafka1-dc1
      - kafka2-dc1
      - kafka3-dc1
      - kafka1-dc2
      - kafka2-dc2
      - kafka3-dc2
    environment:
      # Kafka Connect worker runs in DC1
      CONNECT_BOOTSTRAP_SERVERS: "kafka1-dc1:9092,kafka2-dc1:9092,kafka3-dc1:9092"
      CONNECT_GROUP_ID: "mm2-dc1-group"
      # Internal Connect topics (must be replicated)
      CONNECT_CONFIG_STORAGE_TOPIC: __mm2_configs
      CONNECT_OFFSET_STORAGE_TOPIC: __mm2_offsets
      CONNECT_STATUS_STORAGE_TOPIC: __mm2_status
      CONNECT_CONFIG_STORAGE_REPLICATION_FACTOR: 3
      CONNECT_OFFSET_STORAGE_REPLICATION_FACTOR: 3
      CONNECT_STATUS_STORAGE_REPLICATION_FACTOR: 3
    command: >
      bash -c "
      /opt/kafka/bin/connect-mirror-maker.sh /opt/mm2.properties
      "
    healthcheck:
      test: [ "CMD-SHELL", "grep -q 'Kafka MirrorMaker started' /opt/kafka/logs/connect.log" ]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 30s
    volumes:
      - ./config/mm2.properties:/opt/mm2.properties
    networks: [ dc1, dc2 ]

  ##############################
  ###  Kafka Console (AKHQ)  ###
  ##############################

  akhq:
    image: tchiotludo/akhq:0.26.0
    depends_on:
      - kafka1-dc1
      - kafka1-dc2
    restart: always
    environment:
      AKHQ_CONFIGURATION: |
        akhq:
          connections:
            dc1:
              properties:
                bootstrap.servers: "kafka1-dc1:9092,kafka2-dc1:9092,kafka3-dc1:9092"
            dc2:
              properties:
                bootstrap.servers: "kafka1-dc2:9092,kafka2-dc2:9092,kafka3-dc2:9092"
    ports:
      - "8081:8080"
    networks: [ dc1, dc2 ]

  #######################
  ###  Demo Services  ###
  #######################

  demo-service:
    image: udocirkel/kafka-example/demo-service:1.0.0
    restart: always
    depends_on:
      kafka1-dc1:
        condition: service_started
    environment:
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka1-dc1:9092,kafka2-dc1:9092,kafka3-dc1:9092
      APP_TOPIC_NAME: demo-service-topic
      APP_TOPIC_PARTITIONS: 4
      APP_TOPIC_REPLICAS: 3
      APP_TOPIC_MIN_INSYNC_REPLICAS: 2
      LOG_LEVEL: DEBUG
    ports:
      - "8087:8080"
    networks: [ dc1 ]
