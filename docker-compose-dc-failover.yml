networks:
  dc1:
    driver: bridge
    ipam:
      config:
        - subnet: 192.168.155.0/24
  dc2:
    driver: bridge
    ipam:
      config:
        - subnet: 192.168.156.0/24

services:

  # Kafka Console (AKHQ) => http://localhost:8081

  #############################################
  ###  Kafka Cluster - Data Center 1 (DC1)  ###
  #############################################

  zookeeper-dc1:
    image: confluentinc/cp-zookeeper:7.8.6
    hostname: zookeeper-dc1
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
      ZOOKEEPER_SYNC_LIMIT: 2
    healthcheck:
      test: [ "CMD-SHELL", "echo srvr | nc localhost 2181 | grep Mode" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    volumes:
      - ./data/dc_failover_demo/zookeeper_dc1/data:/var/lib/zookeeper/data
      - ./data/dc_failover_demo/zookeeper_dc1/log:/var/lib/zookeeper/log
    networks:
      dc1:
        ipv4_address: 192.168.155.2

  kafka1-dc1:
    image: confluentinc/cp-kafka:7.8.6
    hostname: kafka1-dc1
    depends_on:
      - zookeeper-dc1
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper-dc1:2181
      KAFKA_LISTENERS: PLAINTEXT://:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka1-dc1:9092
      # Rule of thumb: replication factor ≈ 3, min ISR ≈ 2–3, regardless of having 3, 5, or 7 brokers.
      # Additional brokers are mainly for load distribution and future replicas/partitions.
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 2
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: true
      # Kafka leader rebalance
      KAFKA_AUTO_LEADER_REBALANCE_ENABLE: true
      KAFKA_LEADER_IMBALANCE_CHECK_INTERVAL_SECONDS: 60
      KAFKA_LEADER_IMBALANCE_PER_BROKER_PERCENTAGE: 10
    healthcheck:
      test: [ "CMD", "bash", "-c", "kafka-broker-api-versions --bootstrap-server kafka1-dc1:9092 > /dev/null 2>&1" ]
      interval: 10s
      timeout: 10s
      retries: 12
      start_period: 30s
    volumes:
      - ./data/dc_failover_demo/kafka1_dc1:/var/lib/kafka/data
    networks:
      dc1:
        ipv4_address: 192.168.155.10

  kafka2-dc1:
    image: confluentinc/cp-kafka:7.8.6
    hostname: kafka2-dc1
    depends_on:
      - zookeeper-dc1
    environment:
      KAFKA_BROKER_ID: 2
      KAFKA_ZOOKEEPER_CONNECT: zookeeper-dc1:2181
      KAFKA_LISTENERS: PLAINTEXT://:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka2-dc1:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 2
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: true
      # Kafka leader rebalance
      KAFKA_AUTO_LEADER_REBALANCE_ENABLE: true
      KAFKA_LEADER_IMBALANCE_CHECK_INTERVAL_SECONDS: 60
      KAFKA_LEADER_IMBALANCE_PER_BROKER_PERCENTAGE: 10
    healthcheck:
      test: [ "CMD", "bash", "-c", "kafka-broker-api-versions --bootstrap-server kafka2-dc1:9092 > /dev/null 2>&1" ]
      interval: 10s
      timeout: 10s
      retries: 12
      start_period: 30s
    volumes:
      - ./data/dc_failover_demo/kafka2_dc1:/var/lib/kafka/data
    networks:
      dc1:
        ipv4_address: 192.168.155.11

  kafka3-dc1:
    image: confluentinc/cp-kafka:7.8.6
    hostname: kafka3-dc1
    depends_on:
      - zookeeper-dc1
    environment:
      KAFKA_BROKER_ID: 3
      KAFKA_ZOOKEEPER_CONNECT: zookeeper-dc1:2181
      KAFKA_LISTENERS: PLAINTEXT://:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka3-dc1:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 2
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: true
      # Kafka leader rebalance
      KAFKA_AUTO_LEADER_REBALANCE_ENABLE: true
      KAFKA_LEADER_IMBALANCE_CHECK_INTERVAL_SECONDS: 60
      KAFKA_LEADER_IMBALANCE_PER_BROKER_PERCENTAGE: 10
    healthcheck:
      test: [ "CMD", "bash", "-c", "kafka-broker-api-versions --bootstrap-server kafka3-dc1:9092 > /dev/null 2>&1" ]
      interval: 10s
      timeout: 10s
      retries: 12
      start_period: 30s
    volumes:
      - ./data/dc_failover_demo/kafka3_dc1:/var/lib/kafka/data
    networks:
      dc1:
        ipv4_address: 192.168.155.12

  #############################################
  ###  Kafka Cluster - Data Center 2 (DC2)  ###
  #############################################

  zookeeper-dc2:
    image: confluentinc/cp-zookeeper:7.8.6
    hostname: zookeeper-dc2
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
      ZOOKEEPER_SYNC_LIMIT: 2
    healthcheck:
      test: [ "CMD-SHELL", "echo srvr | nc localhost 2181 | grep Mode" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    volumes:
      - ./data/dc_failover_demo/zookeeper_dc2/data:/var/lib/zookeeper/data
      - ./data/dc_failover_demo/zookeeper_dc2/log:/var/lib/zookeeper/log
    networks:
      dc2:
        ipv4_address: 192.168.156.2

  kafka1-dc2:
    image: confluentinc/cp-kafka:7.8.6
    hostname: kafka1-dc2
    depends_on:
      - zookeeper-dc2
    environment:
      KAFKA_BROKER_ID: 4
      KAFKA_ZOOKEEPER_CONNECT: zookeeper-dc2:2181
      KAFKA_LISTENERS: PLAINTEXT://:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka1-dc2:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 2
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: true
      # Kafka leader rebalance
      KAFKA_AUTO_LEADER_REBALANCE_ENABLE: true
      KAFKA_LEADER_IMBALANCE_CHECK_INTERVAL_SECONDS: 60
      KAFKA_LEADER_IMBALANCE_PER_BROKER_PERCENTAGE: 10
    healthcheck:
      test: [ "CMD", "bash", "-c", "kafka-broker-api-versions --bootstrap-server kafka1-dc2:9092 > /dev/null 2>&1" ]
      interval: 10s
      timeout: 10s
      retries: 12
      start_period: 30s
    volumes:
      - ./data/dc_failover_demo/kafka1_dc2:/var/lib/kafka/data
    networks:
      dc2:
        ipv4_address: 192.168.156.10

  kafka2-dc2:
    image: confluentinc/cp-kafka:7.8.6
    hostname: kafka2-dc2
    depends_on:
      - zookeeper-dc2
    environment:
      KAFKA_BROKER_ID: 5
      KAFKA_ZOOKEEPER_CONNECT: zookeeper-dc2:2181
      KAFKA_LISTENERS: PLAINTEXT://:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka2-dc2:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 2
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: true
      # Kafka leader rebalance
      KAFKA_AUTO_LEADER_REBALANCE_ENABLE: true
      KAFKA_LEADER_IMBALANCE_CHECK_INTERVAL_SECONDS: 60
      KAFKA_LEADER_IMBALANCE_PER_BROKER_PERCENTAGE: 10
    healthcheck:
      test: [ "CMD", "bash", "-c", "kafka-broker-api-versions --bootstrap-server kafka2-dc2:9092 > /dev/null 2>&1" ]
      interval: 10s
      timeout: 10s
      retries: 12
      start_period: 30s
    volumes:
      - ./data/dc_failover_demo/kafka2_dc2:/var/lib/kafka/data
    networks:
      dc2:
        ipv4_address: 192.168.156.11

  kafka3-dc2:
    image: confluentinc/cp-kafka:7.8.6
    hostname: kafka3-dc2
    depends_on:
      - zookeeper-dc2
    environment:
      KAFKA_BROKER_ID: 6
      KAFKA_ZOOKEEPER_CONNECT: zookeeper-dc2:2181
      KAFKA_LISTENERS: PLAINTEXT://:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka3-dc2:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 2
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: true
      # Kafka leader rebalance
      KAFKA_AUTO_LEADER_REBALANCE_ENABLE: true
      KAFKA_LEADER_IMBALANCE_CHECK_INTERVAL_SECONDS: 60
      KAFKA_LEADER_IMBALANCE_PER_BROKER_PERCENTAGE: 10
    healthcheck:
      test: [ "CMD", "bash", "-c", "kafka-broker-api-versions --bootstrap-server kafka3-dc2:9092 > /dev/null 2>&1" ]
      interval: 10s
      timeout: 10s
      retries: 12
      start_period: 30s
    volumes:
      - ./data/dc_failover_demo/kafka3_dc2:/var/lib/kafka/data
    networks:
      dc2:
        ipv4_address: 192.168.156.12

  ################################################
  ###  MirrorMaker 2 (single worker for demo)  ###
  ################################################

  mirrormaker-dc1:
    image: apache/kafka:4.1.1
    depends_on:
#      kafka1-dc1: { condition: service_healthy }
#      kafka2-dc1: { condition: service_healthy }
#      kafka3-dc1: { condition: service_healthy }
#      kafka1-dc2: { condition: service_healthy }
#      kafka2-dc2: { condition: service_healthy }
#      kafka3-dc2: { condition: service_healthy }
      - kafka1-dc1
      - kafka2-dc1
      - kafka3-dc1
      - kafka1-dc2
      - kafka2-dc2
      - kafka3-dc2
    environment:
      # Kafka Connect worker runs in DC1
      CONNECT_BOOTSTRAP_SERVERS: "kafka1-dc1:9092,kafka2-dc1:9092,kafka3-dc1:9092"
      CONNECT_GROUP_ID: "mm2-dc1-group"
      # Internal Connect topics (must be replicated)
      CONNECT_CONFIG_STORAGE_TOPIC: __mm2_configs
      CONNECT_OFFSET_STORAGE_TOPIC: __mm2_offsets
      CONNECT_STATUS_STORAGE_TOPIC: __mm2_status
      CONNECT_CONFIG_STORAGE_REPLICATION_FACTOR: 3
      CONNECT_OFFSET_STORAGE_REPLICATION_FACTOR: 3
      CONNECT_STATUS_STORAGE_REPLICATION_FACTOR: 3
    command: >
      bash -c "
      /opt/kafka/bin/connect-mirror-maker.sh /opt/mm2.properties
      "
    healthcheck:
      test: [ "CMD-SHELL", "ps aux | grep -v grep | grep -q ConnectDistributed" ]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 30s
#    healthcheck:
#      test: [ "CMD-SHELL", "/opt/kafka/bin/kafka-topics.sh --bootstrap-server kafka1-dc1:9092 --list > /dev/null 2>&1" ]
#      interval: 10s
#      timeout: 10s
#      retries: 12
#      start_period: 30s
    volumes:
      - ./config/mm2.properties:/opt/mm2.properties
    networks: [ dc1, dc2 ]

  ##############################
  ###  Kafka Console (AKHQ)  ###
  ##############################

  akhq:
    image: tchiotludo/akhq:0.26.0
    depends_on:
      - kafka1-dc1
      - kafka1-dc2
    environment:
      AKHQ_CONFIGURATION: |
        akhq:
          connections:
            dc1:
              properties:
                bootstrap.servers: "kafka1-dc1:9092,kafka2-dc1:9092,kafka3-dc1:9092"
            dc2:
              properties:
                bootstrap.servers: "kafka1-dc2:9092,kafka2-dc2:9092,kafka3-dc2:9092"
    ports:
      - "8081:8080"
    networks: [ dc1, dc2 ]

